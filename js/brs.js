"use strict";var BrsOData=function e(t,a,n,r){this.url=t,this.urlProfiles=a,this.fail=r||function(){},this.done=n||function(){}};BrsOData.CONVENTIONS=[{name:"basel"},{name:"rotterdam"},{name:"stockholm"}],BrsOData.LANGUAGES=[{id:"en",name:"English",value:"English"},{id:"fr",name:"French",value:"Français"},{id:"es",name:"Spanish",value:"Español"},{id:"ru",name:"Russian",value:"Русский"},{id:"ar",name:"Arabic",value:"العربية"},{id:"zh",name:"Chinese",value:"中国的"},{id:"pt",name:"Portuguese",value:"Portuguese"}],BrsOData.LISTTYPETOFIELD={term:"Terms",programme:"Programs",tag:"Tags",meetingtype:"MeetingsTypes",chemical:"Chemicals",meeting:"Meetings",type:"Types"},BrsOData.prototype.ODATA3SCHEMA={data:function e(t){return t.value},total:function e(t){return t["odata.count"]}},BrsOData.prototype.getDataSource=function(e){return new kendo.data.DataSource({type:"odata",transport:{read:{url:e.baseUrl+"/"+e.entryUrl+"/",dataType:"jsonp",data:$.extend({$inlinecount:"allpages"},e.data)}},sort:e.sort,serverPaging:!0,serverSorting:!0,page:e.page,pageSize:e.pageSize,schema:{data:function e(t){return t.value?t.value:t.d.results},total:function e(t){return t["odata.count"]?t["odata.count"]:t.d.__count},serverPaging:!0,model:{fields:e.fields}}})},BrsOData.prototype.listTypesDataSource=function(){return this.getDataSource({baseUrl:this.url,entryUrl:"ValueTypes",fields:{id:"ListPropertyTypeId",value:"Name"}})},BrsOData.prototype.countriesDataSource=function(){return this.getDataSource({baseUrl:this.urlProfiles,entryUrl:"countryNames",fields:{id:"IsoCode2d",value:"NameEn"},sort:{field:"NameEn"}})},BrsOData.prototype.conventionsDataSource=function(){return new kendo.data.DataSource({type:"json",data:BrsOData.CONVENTIONS.slice(),sort:{field:"value",dir:"asc"},schema:{model:{fields:{value:"name"}}}})},BrsOData.prototype.languagesDataSource=function(){return new kendo.data.DataSource({type:"json",data:$.merge([],BrsOData.LANGUAGES)})},BrsOData.prototype.yearsDataSource=function(e){var t=(new Date).getFullYear();if(e>t)throw"start year '"+e+"' should be less then current year '"+t+"'";for(var a=[],n=t;n>=e;--n)a.push({value:n});return new kendo.data.DataSource({type:"json",data:a})},BrsOData.prototype.listTypeToField=function(e){return BrsOData.LISTTYPETOFIELD[e]},BrsOData.prototype.listsDataSources=function(){var e=this.listTypesDataSource(),t=this;return e.read().then(function(){var a=[];return _.each(e.view(),function(e){var n=t.getDataSource({baseUrl:t.url,entryUrl:"Values",data:{$filter:"Types/any(x: x/ListPropertyTypeId eq guid'"+e.id+"')"},fields:{id:"ListPropertyId",value:"Value"},sort:{field:"value",dir:"asc"}});a.push({type:e.value,data:n})}),a})},BrsOData.prototype._odataOr=function(e,t){var a=[],n="'";for(var r in t)"number"==typeof t[r]&&(n=""),a.push(e+" eq "+n+t[r]+n);return a.join(" or ")},BrsOData.prototype._odataExpandOr=function(e,t,a){var n=[];for(var r in a){var i="'"+a[r]+"'";this.isGUID(a[r])&&(i="guid"+i),n.push(e+"/any(x: x/"+t+" eq "+i+")")}return n.join(" or ")},BrsOData.prototype.isGUID=function(e){var t=/^(\{){0,1}[0-9a-fA-F]{8}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{12}(\}){0,1}$/gi;return t.test(e)},BrsOData.prototype.documentsDataSource=function(e){var t=[],a="",n=e.filters;if(n)for(var r in n){var i=n[r];if(i.length>0)switch(r){case"convention":t.push("("+this._odataOr("Convention",i)+")");break;case"language":t.push("("+this._odataExpandOr("Titles","Language",i)+")");break;case"year":t.push("("+this._odataOr("year(PublicationDate)",i)+")");break;case"country":t.push("("+this._odataOr("Country",i)+")");break;default:var s=this.listTypeToField(r);t.push("("+this._odataExpandOr(s,"ListPropertyId",i)+")")}}return a=t.join(" and "),this.getDataSource({baseUrl:this.url,entryUrl:"Documents",data:{$expand:"Titles,Descriptions,Files",$filter:a},page:e.page,pageSize:e.pageSize,sort:e.sort})},$.fn.brsODataUI=function(e){function t(e){var t=$(e.sender.element).data("brs-filter");p[t]=this.value();var a=u.documentsDataSource(f);o(a)}function a(e){$("select[data-brs-list]",l.parentEl).each(function(a,n){var r=$(n).data("brs-filter"),i=_.find(e,function(e){return e.type==r}).data;$(n).kendoMultiSelect({dataSource:i,dataTextField:"value",dataValueField:"id",change:t}).data("kendoMultiSelect").value(p[r])})}function n(e){$("select[data-brs-filter='convention']",l.parentEl).each(function(a,n){$(n).kendoMultiSelect({dataSource:e,dataTextField:"value",dataValueField:"value",change:t}).data("kendoMultiSelect").value(p.convention)})}function r(e){$("select[data-brs-filter='language']",l.parentEl).each(function(a,n){$(n).kendoMultiSelect({dataSource:e,dataTextField:"value",dataValueField:"id",change:t})})}function i(e){$("select[data-brs-filter='year']",l.parentEl).each(function(a,n){$(n).kendoMultiSelect({dataSource:e,dataTextField:"value",dataValueField:"value",change:t})})}function s(e){$("select[data-brs-filter='country']",l.parentEl).each(function(a,n){$(n).kendoMultiSelect({dataSource:e,dataTextField:"value",dataValueField:"id",change:t})})}function o(e){$("tbody[data-brs-documents]",l.parentEl).each(function(t,a){var n=c||kendo.template($("#brs-template").html()),r=$(".brs-documents-pager");$(a).kendoListView({dataSource:e,template:n,autoBind:!0,dataBound:function e(){$(".brs-tabstrip",l).each(function(){var e;if(0==p.language.length)e=$("li:first-child");else for(var t=p.language.length-1;t>=0&&(e=$(".brs-tab-"+p.language[t],this),!(e.size()>0));t--);$(this).kendoTabStrip().data("kendoTabStrip").activateTab(e)})}}),r.kendoPager({dataSource:e})})}var l=this,u=e.service,d=e.predefined||{},c=e.template,p={convention:[],language:[],year:[],term:[],programme:[],tag:[],meetingtype:[],chemical:[],meeting:[],type:[],country:[]};p=jQuery.extend(p,d);var f={filters:p,page:1,pageSize:e.pageSize||10,sort:{field:"PublicationDate",dir:"desc"}};u.listsDataSources().then(a),n(u.conventionsDataSource()),r(u.languagesDataSource()),i(u.yearsDataSource(2005)),s(u.countriesDataSource()),o(u.documentsDataSource(f))},$.fn.brsODataUIBuilder=function(e){var t='<div id="brs-filters">',a=new BrsOData("http://informea.pops.int/BrsDocuments/MFiles.svc/","http://informea.pops.int/CountryProfiles/bcTreatyProfile.svc"),n=kendo.template('<div class="brs-filter brs-terms-container">   #= title#   <select data-brs-filter="#= type#" #= list?"data-brs-list":""#></select></div>'),r={};for(var i in e){var s=e[i],o=void 0===s.show||1==s.show;o&&(t+=n($.extend({list:!1},s))),r[s.type]=s.selected||[]}t+="</div>",t+='<div>\n                <div class="brs-filter brs-terms-container">\n                    <table>\n                        <thead>\n                            <tr>\n                                <!--<th>UNnumber</th>-->\n                                <th>Treaty</th>\n                                <th>Country</th>\n                                <th>Publication Date</th>\n                                <th>&nbsp;</th>\n                            </tr>\n                        </thead>\n                        <tbody data-brs-documents>\n                        </tbody>\n                    </table>\n                </div>\n                <div class="brs-documents-pager"></div>\n        </div>';var l='<tr>\n            <td>#= Convention#</td>\n            <td>#= CountryFull != null? CountryFull: "" #</td>\n            <td>#= PublicationDate != null? kendo.toString(kendo.parseDate(PublicationDate), "y"): "" #</td>\n            <td>\n                    <div class="brs-tabstrip">\n                    <ul>\n                            #  var found;# \n                            #  for (var j = 0; j < Titles.length; j++) { #\n                            #      found = false; # \n                            #      for (var i = 0; i < BrsOData.LANGUAGES.length; i++) { #\n                            #        if (BrsOData.LANGUAGES[i].id == Titles[j].Language) { #\n                                        <li class="brs-tab brs-tab-#: BrsOData.LANGUAGES[i].id#">  #= BrsOData.LANGUAGES[i].value #</li>\n                            #          found=true; break; # \n                            #        } #   \n                            #      } #\n                            #      if (!found){#\n                                        <li class="brs-tab brs-tab-#: Titles[j].Language#">  #= Titles[j].LanguageFull #</li>\n                            #      } #\n                            #  } #\n                    </ul>\n                    # for (var j = 0; j < Titles.length; j++) { #\n                            # for (var i = 0; i < BrsOData.LANGUAGES.length; i++) { #\n                                # found = false; #\n                                # if (BrsOData.LANGUAGES[i].id == Titles[j].Language) {#\n                                    <div>\n                                        <div class="brs-tab-content brs-tab-title">#= Titles[j].Value #</div>\n                                        <!--<div class="brs-tab-content brs-tab-unnumber">#: UnNumber #</div>-->\n                                        <div class="brs-tab-content brs-tab-description">#= Descriptions[j].Value #</div>\n                                        <div class="brs-tab-content brs-tab-files">\n                                            # for (var l = 0; l < Files.length; l++) { # \n                                                    #   if (Files[l].Size == 0 ) {#\n                                                        #      if (Files[l].Extension == \'txt\') {#\n                                                            <div class="brs-tab-content brs-tab-notyet">Not yet implemented</div>\n                                                        #      }#\n                                                    #   } else {#    \n                                                        #   if (Files[l].Language == Titles[j].Language) {#\n                                                        <span class="brs-tab-files-link">\n                                                            <a href="#:Files[l].Url#">#:Files[l].Extension#</a>\n                                                        </span>\n                                                    #}}#\n                                            \n                                            # } #\n                                        </div>\n                                    </div>\n                                    # found = true; break; #\n                                # } #   \n                            # } #\n                    # } #\n                </div>\n            </td>\n        </tr>';$(this).html(t),$(this).brsODataUI({service:a,predefined:r,template:l})};